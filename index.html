<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="888888" name="app-key"/>
    <title>è‚¡ç¥¨ä¼°å€¼è®¡ç®—å™¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        .header { text-align: center; margin: 1rem 0 -3rem; }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 0.1rem; flex-wrap: wrap; margin-left: -150px; }
        .app-title { font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin: 0 0 0 -80px; line-height: 1.2; }
        .logo { height: 190px; width: auto; display: block; margin-bottom: -10px; }
        .calculator { max-width: 800px; margin: 2rem auto; padding: 2rem; border: 1px solid #dee2e6; border-radius: 15px; }
        .disabled-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: none; }
        .growth-input { position: relative; }
        .growth-input::after { content: "%"; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; }
        #recordCardsContainer { background-color: white; padding: 20px; }
        .card.shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
        #stockContent > div { width: 300px; margin: 10px; padding: 15px; box-sizing: border-box; }
        @media (max-width: 768px) {
            .app-title { font-size: 2rem; }
            .logo { height: 150px; }
            .calculator { padding: 1.5rem; margin: 1rem; }
        }
        /* æ–°å¢ï¼šå¯¼å‡ºæŠ¥å‘Šé‡Œçš„è‚¡ç¥¨å¡ç‰‡æ ·å¼ */
        .record-card {
            flex: 1 1 calc(33.333% - 20px);
            min-width: 260px;
            background: linear-gradient(135deg, #f9fafc, #eef2f7);
            border-radius: 20px;
            padding: 16px;
            margin: 10px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
        }
        .record-card .stock-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.4rem;
        }
        .record-card .price {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0.2rem 0;
        }
        .record-card .current-price {
            color: #555;
        }
        .record-card .premium.positive {
            color: #27ae60;
        }
        .record-card .premium.negative {
            color: #e74c3c;
        }
        .record-card .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 6px;
        }

/* ç¾åŒ–å…è´£å£°æ˜æ ·å¼ */
.disclaimer-text {
  max-width: 800px;       /* é™åˆ¶æœ€å¤§å®½åº¦ */
  margin: 20px auto;      /* ä¸Šä¸‹ 20pxï¼Œå·¦å³è‡ªåŠ¨å±…ä¸­ */
  text-align: center;     /* å±…ä¸­å¯¹é½ */
  font-size: 0.9rem;      /* å­—ä½“ç¨å¾®å°ä¸€ç‚¹ */
  line-height: 1.6;       /* è¡Œè·æ‹‰å¼€ï¼Œæ›´æ˜“è¯» */
  color: #6c757d;         /* æŸ”å’Œç°è‰²ï¼Œé¿å…å¤ªæŠ¢çœ¼ */
}
    </style>
</head>
<body>
    <div class="disabled-overlay" id="lockOverlay">
        <div class="position-absolute top-50 start-50 translate-middle">
            <div class="card shadow">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3" id="unlockTitle">éœ€è¦è§£é”ä½¿ç”¨</h5>
                    <div class="input-group mb-3">
                        <input class="form-control" id="inputKey" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥" type="password"/>
                        <button class="btn btn-outline-secondary" onclick="toggleKeyVisibility(this)">ğŸ‘ï¸</button>
                        <button class="btn btn-primary" onclick="unlockCalculator()">è§£é”</button>
                    </div>
                    <p class="text-danger small mb-0" id="keyError" style="display:none;"></p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="keyManagerModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="keyManagerTitle">å¯†é’¥ç®¡ç†</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">å½“å‰å¯†é’¥</label>
                        <input class="form-control" disabled id="currentKey" type="password"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ–°å¯†é’¥ï¼ˆè‡³å°‘6ä½ï¼‰</label>
                        <input class="form-control" id="newKey" type="password"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ç¡®è®¤æ–°å¯†é’¥</label>
                        <input class="form-control" id="confirmKey" type="password"/>
                    </div>
                    <p class="text-danger small" id="keyChangeError" style="display:none;"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="updateKey()" type="button">ä¿å­˜æ›´æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€ -->
    <div class="modal fade" id="editRecordModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">ç¼–è¾‘è®°å½• Edit Record</h5>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">å­£åº¦æ”¶å…¥ (ç™¾ä¸‡)</label>
              <input type="number" class="form-control" id="editRevenue" min="0.01" step="0.01">
            </div>
            <div class="mb-3">
              <label class="form-label">å­£åº¦åˆ©æ¶¦ (ç™¾ä¸‡)</label>
              <input type="number" class="form-control" id="editProfit" min="0.01" step="0.01">
            </div>
<div class="mb-3">
  <label class="form-label">å½“å‰è‚¡ä»·</label>
  <input type="number" class="form-control" id="editCurrentPrice" min="0.01" step="0.01">
</div>
            <div class="mb-3">
              <label class="form-label">æ€»è‚¡æœ¬ (ç™¾ä¸‡è‚¡)</label>
              <input type="number" class="form-control" id="editShares" min="1" step="1">
            </div>
            <div class="mb-3">
              <label class="form-label">é¢„æœŸæˆé•¿å€¼ (%)</label>
              <input type="number" class="form-control" id="editGrowth" min="0" max="100" step="0.1">
            </div>
            <input type="hidden" id="editIndex">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="saveEditedRecord()">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img alt="Logo" class="logo" src="https://i.imgur.com/naIXUw2.png"/>
                <h1 class="app-title">è‚¡ç¥¨ä¼°å€¼è®¡ç®—å™¨</h1>
            </div>
        </header>

        <div class="calculator">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label" id="languageLabel">Language</label>
                    <select class="form-select" id="languageSelect">
                        <option value="en">English</option>
                        <option value="zh">ä¸­æ–‡</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" id="marketLabel">Market</label>
                    <select class="form-select" id="countrySelect">
                        <option value="CHINA">ä¸­å›½ (Â¥)</option>
                        <option value="HK">é¦™æ¸¯ (HK$)</option>
                        <option value="US">ç¾å›½ ($)</option>
                        <option value="MY">é©¬æ¥è¥¿äºš (RM)</option>
                    </select>
                </div>
            </div>

            <!-- æ¡£æ¡ˆè¾“å…¥ä¸åˆ‡æ¢ -->
            <div class="input-group mb-3">
              <input type="text" class="form-control" id="archiveName" placeholder="è¾“å…¥æ¡£æ¡ˆåå­— (å¦‚: ç§‘æŠ€è‚¡2025Q1)">
              <button class="btn btn-outline-primary" id="createArchiveBtn" onclick="createOrSwitchArchive()">ä½¿ç”¨/æ–°å»ºæ¡£æ¡ˆ</button>
            </div>

            <div class="mb-3">
              <label class="form-label">å·²ä¿å­˜çš„æ¡£æ¡ˆï¼š</label>
              <div class="d-flex gap-2">
                <select class="form-select" id="archiveSelect" onchange="switchArchive(this.value)">
                  <option value="">è¯·é€‰æ‹©æ¡£æ¡ˆ</option>
                </select>
                <button class="btn btn-outline-danger" id="deleteArchiveBtn" onclick="deleteArchive()">åˆ é™¤æ¡£æ¡ˆ</button>
              </div>
            </div>

            <div class="mb-4">
                <label class="form-label" id="stockNameLabel">Stock Name</label>
                <input class="form-control" id="stockName" required type="text"/>
                <label class="form-label mt-2" id="currentPriceLabel">å½“å‰è‚¡ä»·</label>
                <input class="form-control" id="currentPrice" min="0.01" required step="0.01" type="number"/>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label" id="quarterRevenueLabel">å­£åº¦æ”¶å…¥ï¼ˆç™¾ä¸‡ï¼‰</label>
                    <input class="form-control" id="quarterRevenue" min="0.01" required step="0.01" type="number"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label" id="quarterProfitLabel">å­£åº¦åˆ©æ¶¦ï¼ˆç™¾ä¸‡ï¼‰</label>
                    <input class="form-control" id="quarterProfit" min="0.01" required step="0.01" type="number"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label" id="totalSharesLabel">æ€»è‚¡æœ¬ï¼ˆç™¾ä¸‡è‚¡ï¼‰</label>
                    <input class="form-control" id="totalShares" min="1" required type="number"/>
                </div>
                <div class="col-md-3 growth-input">
                    <label class="form-label" id="growthLabel">é¢„æœŸæˆé•¿å€¼%</label>
                    <input class="form-control" id="growthRate" max="100" min="0" required step="0.1" type="number" value="0"/>
                </div>
            </div>
            <button class="btn btn-primary w-100 mb-4" id="calculateButton">Calculate & Save</button>

            <div class="mt-4 p-3 bg-light rounded" id="result" style="display: none;">
                <h5 id="resultTitle"></h5>
                <p class="fs-4 text-primary" id="resultPrice"></p>
                <p class="text-muted small mt-3" id="disclaimerText"></p>
            </div>

            <div class="history mt-5">
                <h5 class="mb-3" id="historyTitle">Saved Records</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th id="marketColumn">Market</th>
                                <th id="stockColumn">Stock</th>
                                <th id="currentPriceColumn">Current Price</th>
                                <th id="priceColumn">Price</th>
                                <th id="timeColumn">Time</th>
                                <th id="actionColumn">Action</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æŒ‰é’®åŒºåŸŸï¼ˆå¡ç‰‡/æŠ¥è¡¨/å¯¼å…¥å¯¼å‡º/PDFï¼‰ -->
        <div class="mt-3">
            <button class="btn btn-success w-100 mb-2" onclick="generateAllRecordCards()">ä¸€é”®ç”Ÿæˆå¡ç‰‡ Generate Cards</button>
            <button class="btn btn-info w-100 mb-2" onclick="generateAllRecordReport()">ç”ŸæˆæŠ¥è¡¨ Generate Report</button>
            <button class="btn btn-secondary w-100 mb-2" onclick="exportArchive()">å¯¼å‡ºå½“å‰æ¡£æ¡ˆ Export Archive</button>
            <input type="file" id="importArchiveFile" style="display:none" accept=".json" onchange="importArchive(event)">
            <button class="btn btn-warning w-100 mb-2" onclick="document.getElementById('importArchiveFile').click()">å¯¼å…¥æ¡£æ¡ˆ Import Archive</button>
            <button class="btn btn-danger w-100 mb-4" onclick="downloadPDF()">ä¸‹è½½PDFæŠ¥å‘Š Download PDF</button>
            <div class="mt-4" id="recordCardsContainer"></div>
        </div>
    </div>

    <script>
        const translations = {
            zh: {
                title: "è‚¡ç¥¨ä¼°å€¼è®¡ç®—å™¨",
                unlockTitle: "è§£é”ä½¿ç”¨",
                keyManagerTitle: "å¯†é’¥ç®¡ç†",
                marketLabel: "é€‰æ‹©å¸‚åœº",
                stockNameLabel: "è‚¡ç¥¨åç§°",
                quarterRevenueLabel: "å­£åº¦æ”¶å…¥ï¼ˆç™¾ä¸‡ï¼‰",
                quarterProfitLabel: "å­£åº¦åˆ©æ¶¦ï¼ˆç™¾ä¸‡ï¼‰",
                totalSharesLabel: "æ€»è‚¡æœ¬ï¼ˆç™¾ä¸‡è‚¡ï¼‰",
                growthLabel: "é¢„æœŸæˆé•¿å€¼%",
                calculateButton: "è®¡ç®—å¹¶ä¿å­˜",
                resultTitle: "è®¡ç®—ç»“æœï¼š",
                fairPrice: "åˆç†è‚¡ä»·ï¼š",
                disclaimer: "å…è´£å£°æ˜ï¼šæœ¬è®¡ç®—ç»“æœä»…åŸºäºå­£åº¦æ”¶å…¥ä¸å‡€åˆ©æ¶¦ä¼°ç®—ï¼Œæœªè€ƒè™‘å…¬å¸å‡€èµ„äº§ã€ç°é‡‘æµã€è‚¡æ¯ç‡ã€è¡Œä¸šå‰æ™¯ã€ä¸šåŠ¡æ‰©å¼ ã€è‚¡æƒå˜åŠ¨ã€å®è§‚ç»æµã€ç«äº‰æ ¼å±€ã€ç®¡ç†å±‚å†³ç­–ç­‰å¯èƒ½å½±å“ä¼°å€¼ä¸è‚¡ä»·çš„å› ç´ ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®ã€‚",
                growthNote: "ï¼ˆå·²åŒ…å«{value}%çš„é¢„æœŸæˆé•¿è°ƒæ•´ï¼‰",
                historyTitle: "ä¿å­˜è®°å½•",
                marketColumn: "å¸‚åœº",
                stockColumn: "è‚¡ç¥¨åç§°",
                priceColumn: "åˆç†è‚¡ä»·",
                currentPriceColumn: "å½“å‰è‚¡ä»·",
                timeColumn: "è®¡ç®—æ—¶é—´",
                actionColumn: "æ“ä½œ",
                deleteButton: "åˆ é™¤",
                editButton: "ç¼–è¾‘",
                errorInvalidInput: "è¯·å¡«å†™å®Œæ•´æœ‰æ•ˆçš„è¾“å…¥å€¼",
                errorNegativeProfit: "å‡€åˆ©æ¶¦ç‡ä¸èƒ½ä¸ºè´Ÿæ•°",
                errorStockName: "è‚¡ç¥¨åç§°ä¸èƒ½ä¸ºç©º",
                errorRevenue: "å­£åº¦æ”¶å…¥å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—",
                errorProfit: "å­£åº¦åˆ©æ¶¦å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—",
                errorShares: "æ€»è‚¡æœ¬å¿…é¡»æ˜¯å¤§äºé›¶çš„æ•°å­—",
                growthError: "æˆé•¿å€¼å¿…é¡»åœ¨0-100%ä¹‹é—´",
                keyMismatch: "ä¸¤æ¬¡è¾“å…¥çš„å¯†é’¥ä¸ä¸€è‡´",
                keyTooShort: "å¯†é’¥é•¿åº¦ä¸èƒ½å°‘äº6ä½",
                keyUpdated: "å¯†é’¥å·²æ›´æ–°ï¼Œè¯·é‡æ–°è§£é”ï¼",
                errorNoRecords: "è¯·å…ˆç”Ÿæˆå¡ç‰‡å†ä¸‹è½½",
                currentPriceLabel: "å½“å‰è‚¡ä»·",
                currentPrice: "å½“å‰è‚¡ä»·",
                premiumRate: "æº¢ä»·ç‡",
                errorCurrentPrice: "å½“å‰è‚¡ä»·å¿…é¡»ä¸ºæœ‰æ•ˆæ­£æ•°",
                archiveInputPlaceholder: "è¾“å…¥æ¡£æ¡ˆåå­— (å¦‚: ç§‘æŠ€è‚¡2025Q1)",
                createArchiveButton: "ä½¿ç”¨/æ–°å»ºæ¡£æ¡ˆ",
                archiveLabel: "å·²ä¿å­˜çš„æ¡£æ¡ˆï¼š",
                deleteArchiveButton: "åˆ é™¤æ¡£æ¡ˆ",
                exportArchiveButton: "å¯¼å‡ºå½“å‰æ¡£æ¡ˆ",
                importArchiveButton: "å¯¼å…¥æ¡£æ¡ˆ",
                archiveUntitled: "æœªå‘½åæ¡£æ¡ˆ"
            },
            en: {
                title: "Stock Value Calculator",
                unlockTitle: "Unlock Required",
                keyManagerTitle: "Key Management",
                marketLabel: "Market",
                stockNameLabel: "Stock Name",
                quarterRevenueLabel: "Quarterly Rev (Mil)",
                quarterProfitLabel: "Quarterly Profit (Mil)",
                totalSharesLabel: "Total Shares (Mil)",
                growthLabel: "Growth Rate%",
                calculateButton: "Calculate & Save",
                resultTitle: "Result: ",
                fairPrice: "Fair Price: ",
                disclaimer: "Disclaimer: This calculation result is based solely on quarterly revenue and net profit, without considering factors such as net assets, cash flow, dividend yield, industry outlook, business expansion, shareholding changes, macroeconomic conditions, competition, or management decisions that may affect valuation and stock prices. It is for reference only and does not constitute investment advice.",
                growthNote: "(Applied {value}% growth adjustment)",
                historyTitle: "History Records",
                marketColumn: "Market",
                stockColumn: "Stock",
                priceColumn: "Fair Price",
                currentPriceColumn: "Current Price",
                timeColumn: "Time",
                actionColumn: "Action",
                deleteButton: "Delete",
                editButton: "Edit",
                errorInvalidInput: "Invalid input values",
                errorNegativeProfit: "Negative profit not allowed",
                errorStockName: "Stock name cannot be empty",
                errorRevenue: "Invalid revenue value",
                errorProfit: "Invalid profit value",
                errorShares: "Shares must be greater than zero",
                growthError: "Growth rate must be 0-100%",
                keyMismatch: "Keys do not match",
                keyTooShort: "Key must be at least 6 characters",
                keyUpdated: "Key updated! Please re-authenticate.",
                errorNoRecords: "Please generate cards first",
                currentPriceLabel: "Current Price",
                currentPrice: "Current Price",
                premiumRate: "Premium Rate",
                errorCurrentPrice: "Current price must be a valid positive number",
                archiveInputPlaceholder: "Enter archive name (e.g. TechQ1-2025)",
                createArchiveButton: "Use / Create Archive",
                archiveLabel: "Saved Archives:",
                deleteArchiveButton: "Delete Archive",
                exportArchiveButton: "Export Current Archive",
                importArchiveButton: "Import Archive",
                archiveUntitled: "Untitled Archive"
            }
        };

        let isLocked = true;
        let currentArchive = null; // å½“å‰æ¡£æ¡ˆå

        function initKey() {
            const metaKey = document.querySelector('meta[name="app-key"]');
            if (metaKey && metaKey.content) {
                localStorage.setItem('appKey', metaKey.content);
                console.log('åˆå§‹åŒ–å¯†é’¥: ä»metaæ ‡ç­¾è®¾ç½®', metaKey.content);
            } else {
                console.log('åˆå§‹åŒ–å¯†é’¥å¤±è´¥: metaæ ‡ç­¾æœªæ‰¾åˆ°æˆ–æ— å†…å®¹');
            }
            console.log('å½“å‰localStorageä¸­çš„appKey:', localStorage.getItem('appKey'));
        }

        function toggleKeyVisibility(btn) {
            const input = btn.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function unlockCalculator() {
            const inputKey = document.getElementById('inputKey').value;
            const savedKey = localStorage.getItem('appKey');
            const lang = document.getElementById('languageSelect').value;
            
            if (inputKey === savedKey) {
                isLocked = false;
                document.getElementById('lockOverlay').style.display = 'none';
                enableCalculator(true);
            } else {
                showMessage('keyError', translations[lang].errorInvalidInput);
            }
        }

        function showKeyManager() {
            if (!isLocked) {
                const currentKey = localStorage.getItem('appKey');
                document.getElementById('currentKey').value = currentKey;
                new bootstrap.Modal('#keyManagerModal').show();
            }
        }

        function updateKey() {
            const newKey = document.getElementById('newKey').value;
            const confirmKey = document.getElementById('confirmKey').value;
            const lang = document.getElementById('languageSelect').value;

            if (newKey !== confirmKey) {
                showMessage('keyChangeError', translations[lang].keyMismatch);
                return;
            }
            if (newKey.length < 6) {
                showMessage('keyChangeError', translations[lang].keyTooShort);
                return;
            }

            localStorage.setItem('appKey', newKey);
            new bootstrap.Modal('#keyManagerModal').hide();
            alert(translations[lang].keyUpdated);
            lockCalculator();
        }

        function showMessage(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }

        function lockCalculator() {
            isLocked = true;
            document.getElementById('lockOverlay').style.display = 'block';
            enableCalculator(false);
        }

        function enableCalculator(enabled) {
            const elements = ['#stockName', '#currentPrice', '#quarterRevenue', '#quarterProfit', '#totalShares', 
                             '#calculateButton', '#languageSelect', '#countrySelect', '#growthRate', '#archiveName', '#createArchiveBtn'];
            elements.forEach(selector => {
                const el = document.querySelector(selector);
                if (el) el.disabled = !enabled;
            });
            console.log('è®¡ç®—å™¨çŠ¶æ€:', enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨');
        }

        // è®¡ç®—å‡½æ•°ï¼ˆè°ƒç”¨ä¿å­˜ï¼‰
        function calculate() {
            const lang = document.getElementById('languageSelect').value;
            const country = document.getElementById('countrySelect').value;
            const stockName = document.getElementById('stockName').value.trim();
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            const qRevenue = parseFloat(document.getElementById('quarterRevenue').value);
            const qProfit = parseFloat(document.getElementById('quarterProfit').value);
            const shares = parseFloat(document.getElementById('totalShares').value);
            const growthRate = parseFloat(document.getElementById('growthRate').value);

            if (!validateInputs(lang, stockName, currentPrice, qRevenue, qProfit, shares, growthRate)) return;

            const profitMargin = Math.round((qProfit / qRevenue) * 100);
            if (profitMargin < 0) {
                alert(translations[lang].errorNegativeProfit);
                return;
            }

            const adjustmentFactor = profitMargin * 0.2;
            const annualRevenue = qRevenue * 4;
            const baseValue = (annualRevenue * adjustmentFactor) / shares;
            let finalValue = baseValue * (1 + growthRate / 100);
            if (shares < 500) finalValue *= 0.8;
            else if (shares < 1000) finalValue *= 0.9;
            finalValue = Math.max(0, finalValue);
            const currency = { CHINA: 'Â¥', HK: 'HK$', US: '$', MY: 'RM' }[country];

            showResult(lang, stockName, currency, finalValue, growthRate);
            saveRecord(country, stockName, finalValue, currentPrice, growthRate);
            loadHistory();
        }

        function validateInputs(lang, stockName, currentPrice, qRevenue, qProfit, shares, growthRate) {
            const errors = [];
            
            if (!stockName) errors.push(translations[lang].errorStockName);
            if (isNaN(currentPrice) || currentPrice <= 0) errors.push(translations[lang].errorCurrentPrice);
            if (isNaN(qRevenue) || qRevenue <= 0) errors.push(translations[lang].errorRevenue);
            if (isNaN(qProfit) || qProfit <= 0) errors.push(translations[lang].errorProfit);
            if (isNaN(shares) || shares <= 0) errors.push(translations[lang].errorShares);
            if (isNaN(growthRate) || growthRate < 0 || growthRate > 100) errors.push(translations[lang].growthError);

            if (errors.length > 0) {
                alert(`${translations[lang].errorInvalidInput}\n\nâ€¢ ${errors.join('\nâ€¢ ')}`);
                return false;
            }
            return true;
        }

        function showResult(lang, stockName, currency, value, growthRate) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            document.getElementById('resultTitle').textContent = `${translations[lang].resultTitle} ${stockName}`;
            document.getElementById('resultPrice').textContent = `${translations[lang].fairPrice} ${currency} ${value.toFixed(2)}`;
            document.getElementById('disclaimerText').textContent = translations[lang].disclaimer;
        }

        // ====== æ¡£æ¡ˆç®¡ç† & å†å²è®°å½• (æŠŠ record å­˜åˆ° archive_<name> ) ======
        function loadArchiveList() {
            const archiveSelect = document.getElementById('archiveSelect');
            archiveSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¡£æ¡ˆ</option>';
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('archive_')) {
                    const archiveName = key.replace('archive_', '');
                    const option = document.createElement('option');
                    option.value = archiveName;
                    option.textContent = archiveName;
                    archiveSelect.appendChild(option);
                }
            });
        }

        function createOrSwitchArchive() {
            const name = document.getElementById('archiveName').value.trim();
            if (!name) {
                alert("è¯·è¾“å…¥æ¡£æ¡ˆåå­—ï¼");
                return;
            }
            currentArchive = name;
            if (!localStorage.getItem('archive_' + name)) {
                localStorage.setItem('archive_' + name, '[]');
                alert("å·²æ–°å»ºæ¡£æ¡ˆï¼š" + name);
            } else {
                alert("å·²åˆ‡æ¢åˆ°æ¡£æ¡ˆï¼š" + name);
            }
            loadArchiveList();
            document.getElementById('archiveSelect').value = name;
            loadHistory();
        }

        function switchArchive(name) {
            if (!name) return;
            currentArchive = name;
            loadHistory();
            alert("å·²åˆ‡æ¢åˆ°æ¡£æ¡ˆï¼š" + name);
        }

        function deleteArchive() {
            if (!currentArchive) {
                alert("è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ¡£æ¡ˆï¼");
                return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ¡£æ¡ˆ "${currentArchive}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                localStorage.removeItem('archive_' + currentArchive);
                alert("æ¡£æ¡ˆå·²åˆ é™¤ï¼š" + currentArchive);
                currentArchive = null;
                loadArchiveList();
                document.getElementById('historyTable').innerHTML = '';
                document.getElementById('recordCardsContainer').innerHTML = '';
            }
        }

        // ä¿å­˜è®°å½•åˆ°å½“å‰æ¡£æ¡ˆï¼ˆåŒ…å«æ”¶å…¥/åˆ©æ¶¦/è‚¡æœ¬/growthï¼‰
        function saveRecord(country, name, price, currentPrice, growthRate) {
            if (!currentArchive) {
                alert("è¯·å…ˆè¾“å…¥æˆ–é€‰æ‹©ä¸€ä¸ªæ¡£æ¡ˆåå­—ï¼");
                return;
            }
            const qRevenue = parseFloat(document.getElementById('quarterRevenue').value);
            const qProfit = parseFloat(document.getElementById('quarterProfit').value);
            const shares = parseFloat(document.getElementById('totalShares').value);

            const premium = ((price - currentPrice) / currentPrice * 100).toFixed(1);
            const record = {
                country: country,
                name: name,
                price: price.toFixed(2),
                currentPrice: currentPrice.toFixed(2),
                growth: growthRate.toFixed(1),
                premium: premium,
                revenue: qRevenue.toFixed(2),
                profit: qProfit.toFixed(2),
                shares: Math.round(shares).toString(),
                timestamp: new Date().toLocaleDateString()
            };
            
            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
            history = history.slice(-49);
            history.push(record);
            localStorage.setItem('archive_' + currentArchive, JSON.stringify(history));
        }

        // åŠ è½½å½“å‰æ¡£æ¡ˆå†å²åˆ°è¡¨æ ¼
        function loadHistory() {
            const lang = document.getElementById('languageSelect').value;
            const tbody = document.getElementById('historyTable');

            if (!currentArchive) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-muted text-center">å°šæœªé€‰æ‹©æ¡£æ¡ˆ / No archive selected</td></tr>';
                return;
            }

            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
history = sortByPremium(history);
            if (history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">å½“å‰æ¡£æ¡ˆæš‚æ— è®°å½• / No records in this archive</td></tr>';
                return;
            }

            tbody.innerHTML = history.map((item, index) => `
                <tr>
                    <td>${item.country}</td>
                    <td>${item.name}</td>
                    <td>${getCurrencySymbol(item.country)} ${item.currentPrice}</td>
                    <td>${getCurrencySymbol(item.country)} ${item.price} <small class="${parseFloat(item.premium) >= 0 ? 'text-success' : 'text-danger'}">(${item.premium}%)</small></td>
                    <td>${item.timestamp}</td>
                    <td>
                      <button class="btn btn-sm btn-primary me-1" onclick="editRecord(${index})">${translations[lang].editButton}</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteRecord(${index})">${translations[lang].deleteButton}</button>
                    </td>
                </tr>
            `).join('');
        }

        function deleteRecord(index) {
            if (!currentArchive) return;
            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
history = sortByPremium(history);
            history.splice(index, 1);
            localStorage.setItem('archive_' + currentArchive, JSON.stringify(history));
            loadHistory();
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(index) {
            if (!currentArchive) return;
            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
history = sortByPremium(history);
            const item = history[index];
            if (!item) return;

            document.getElementById('editIndex').value = index;
            document.getElementById('editRevenue').value = item.revenue || "";
            document.getElementById('editProfit').value = item.profit || "";
document.getElementById('editCurrentPrice').value = item.currentPrice || "";
            document.getElementById('editShares').value = item.shares || "";
            document.getElementById('editGrowth').value = item.growth || "";

            new bootstrap.Modal(document.getElementById('editRecordModal')).show();
        }

        // ä¿å­˜ç¼–è¾‘åçš„è®°å½•ï¼Œå¹¶é‡æ–°è®¡ç®—åˆç†ä»·ä¸æº¢ä»·
        function saveEditedRecord() {
            const index = parseInt(document.getElementById('editIndex').value);
            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
            let item = history[index];
            if (!item) return;

            const revenue = parseFloat(document.getElementById('editRevenue').value);
            const profit = parseFloat(document.getElementById('editProfit').value);
const currentPrice = parseFloat(document.getElementById('editCurrentPrice').value);
            const shares = parseFloat(document.getElementById('editShares').value);
            const growth = parseFloat(document.getElementById('editGrowth').value);

            if (isNaN(revenue) || isNaN(profit) || isNaN(shares) || isNaN(growth)) {
    alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼ï¼");
    return;
}

if (isNaN(currentPrice) || currentPrice <= 0) {
    alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å½“å‰è‚¡ä»·ï¼");
    return;
}



            // é‡æ–°è®¡ç®—åˆç†è‚¡ä»·
            const profitMargin = Math.round((profit / revenue) * 100);
            const adjustmentFactor = profitMargin * 0.2;
            const annualRevenue = revenue * 4;
            const baseValue = (annualRevenue * adjustmentFactor) / shares;
            let finalValue = baseValue * (1 + growth / 100);
            if (shares < 500) finalValue *= 0.8;
            else if (shares < 1000) finalValue *= 0.9;
            finalValue = Math.max(0, finalValue);

            // æ›´æ–°è®°å½•å­—æ®µ
            item.revenue = revenue.toFixed(2);
            item.profit = profit.toFixed(2);
            item.shares = Math.round(shares).toString();
            item.growth = growth.toFixed(1);
            item.price = finalValue.toFixed(2);

            item.currentPrice = currentPrice.toFixed(2);
item.premium = ((finalValue - currentPrice) / currentPrice * 100).toFixed(1);
            item.timestamp = new Date().toLocaleDateString();

            history[index] = item;
            localStorage.setItem('archive_' + currentArchive, JSON.stringify(history));

            bootstrap.Modal.getInstance(document.getElementById('editRecordModal')).hide();
            loadHistory();
            alert("è®°å½•å·²æ›´æ–° âœ…");
        }

        // ==== ç”Ÿæˆå¡ç‰‡/æŠ¥è¡¨ï¼Œæ˜¾ç¤ºå½“å‰æ¡£æ¡ˆåå­— ====
        function generateAllRecordCards() {
            let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
history = sortByPremium(history);
            const container = document.getElementById('recordCardsContainer');
            container.innerHTML = '';

            if (!currentArchive || history.length === 0) {
                const lang = document.getElementById('languageSelect').value;
                alert(translations[lang].errorNoRecords);
                return;
            }

            const lang = document.getElementById('languageSelect').value;
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'card shadow p-4';

            cardWrapper.innerHTML = `
                <div class="d-flex align-items-center mb-8" style="margin-left: 16rem;">
    <img src="https://i.imgur.com/naIXUw2.png" alt="Logo" style="width:400px; height:auto; margin-right:-7rem;">
    <h2 style="font-size: 2.5rem; font-weight: 700; margin:0;">${translations[lang].title}</h2>
</div>
<div class="disclaimer-text">
    ${translations[lang].disclaimer}
</div>
<div class="text-center mb-4">
    <h3 style="font-size: 2rem; font-weight: 700; color:#2c3e50;">
        ${currentArchive || translations[lang].archiveUntitled}
    </h3>
</div>
                <div class="d-flex flex-wrap" id="stockContent"></div>
            `;

            container.appendChild(cardWrapper);
            const stockContent = cardWrapper.querySelector('#stockContent');

            history.forEach((item) => {
                const stock = document.createElement('div');
                stock.className = 'record-card';
                stock.innerHTML = `
                    <div class="stock-name">${item.name} (${item.country})</div>
                    <div class="price">${translations[lang].priceColumn}: ${getCurrencySymbol(item.country)} ${item.price}</div>
                    <div class="price current-price">${translations[lang].currentPrice}: ${getCurrencySymbol(item.country)} ${item.currentPrice}</div>
                    <div class="premium ${parseFloat(item.premium) >= 0 ? 'positive' : 'negative'}">${translations[lang].premiumRate}: ${item.premium}%</div>
                    <div class="timestamp">${item.timestamp}</div>
                `;
                stockContent.appendChild(stock);
            });
        }

        function generateAllRecordReport() {
    let history = JSON.parse(localStorage.getItem('archive_' + currentArchive) || '[]');
history = sortByPremium(history);
    const container = document.getElementById('recordCardsContainer');
    container.innerHTML = '';

    if (!currentArchive || history.length === 0) {
        const lang = document.getElementById('languageSelect').value;
        alert(translations[lang].errorNoRecords);
        return;
    }

    const lang = document.getElementById('languageSelect').value;
    const reportWrapper = document.createElement('div');
    reportWrapper.className = 'card shadow p-4';

    reportWrapper.innerHTML = `
        <div class="d-flex align-items-center mb-8" style="margin-left: 16rem;">
            <img src="https://i.imgur.com/naIXUw2.png" alt="Logo" 
                 style="width:400px; height:auto; margin-right:-7rem;">
            <h2 style="font-size: 2.5rem; font-weight: 700; margin:0;">
                ${translations[lang].title}
            </h2>
        </div>
        <div class="disclaimer-text">
    ${translations[lang].disclaimer}
</div>
        <div class="text-center mb-4">
            <h3 style="font-size: 2rem; font-weight: 700; color:#2c3e50;">
                ${currentArchive || translations[lang].archiveUntitled}
            </h3>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-light">
                    <tr>
                        <!-- å·²å»æ‰å¸‚åœº Market -->
                        <th>${translations[lang].stockColumn}</th>
                        <th>${translations[lang].priceColumn}</th>
                        <th>${translations[lang].currentPriceColumn}</th>
                        <th>${translations[lang].premiumRate}</th>
                        <th>${translations[lang].timeColumn}</th>
                    </tr>
                </thead>
                <tbody id="reportTable"></tbody>
            </table>
        </div>
    `;

    container.appendChild(reportWrapper);

    const tbody = reportWrapper.querySelector('#reportTable');
    tbody.innerHTML = history.map(item => `
        <tr>
            <!-- å»æ‰äº†å¸‚åœº -->
            <td>${item.name}</td>
            <td>${getCurrencySymbol(item.country)} ${item.price}</td>
            <td>${getCurrencySymbol(item.country)} ${item.currentPrice}</td>
            <td class="${parseFloat(item.premium) >= 0 ? 'text-success' : 'text-danger'}">${item.premium}%</td>
            <td>${item.timestamp}</td>
        </tr>
    `).join('');
}


        // å¯¼å‡ºå½“å‰æ¡£æ¡ˆä¸º JSON
        function exportArchive() {
            if (!currentArchive) {
                alert("è¯·å…ˆé€‰æ‹©æ¡£æ¡ˆå†å¯¼å‡ºï¼");
                return;
            }
            const data = localStorage.getItem('archive_' + currentArchive) || '[]';
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `archive_${currentArchive}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ¡£æ¡ˆï¼ˆä¼šè®©ç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ¡£æ¡ˆåï¼‰
        function importArchive(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data)) {
                        alert("æ–‡ä»¶æ ¼å¼é”™è¯¯");
                        return;
                    }
                    let defaultName = file.name.replace(/\.json$/i, '') || 'imported_archive';
                    const name = prompt("è¾“å…¥è¦ä¿å­˜çš„æ¡£æ¡ˆåå­—ï¼ˆå°†å¯¼å…¥ä¸ºæ­¤æ¡£æ¡ˆï¼‰ï¼š", defaultName);
                    if (!name) {
                        alert("å·²å–æ¶ˆå¯¼å…¥ã€‚");
                        return;
                    }
                    if (localStorage.getItem('archive_' + name)) {
                        if (!confirm("æ¡£æ¡ˆå·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿï¼ˆOK è¦†ç›– / Cancel å–æ¶ˆï¼‰")) {
                            return;
                        }
                    }
                    localStorage.setItem('archive_' + name, JSON.stringify(data));
                    loadArchiveList();
                    alert("å¯¼å…¥æˆåŠŸ");
                } catch (err) {
                    console.error(err);
                    alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶å¯èƒ½ä¸æ˜¯æœ‰æ•ˆ JSONã€‚");
                }
            };
            reader.readAsText(file);
            // æ¸…ç©º inputï¼Œæ–¹ä¾¿ä¸‹æ¬¡å¯¼å…¥ç›¸åŒæ–‡ä»¶
            event.target.value = '';
        }

        // ä¸‹è½½æ˜¾ç¤ºåŒºä¸º PDFï¼ˆå·²ç•™ç”¨ï¼‰
        async function downloadPDF() {
            const container = document.getElementById('recordCardsContainer');
            const lang = document.getElementById('languageSelect').value;

            if (!container.children.length) {
                alert(translations[lang].errorNoRecords);
                return;
            }

            try {
                const canvas = await new Promise(resolve => {
                    setTimeout(() => {
                        resolve(html2canvas(container, { scale: 2, useCORS: true, backgroundColor: '#ffffff' }));
                    }, 300);
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');

                const pageWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = pageWidth - 20;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save('stock_report.pdf');
            } catch (error) {
                console.error('PDFç”Ÿæˆå¤±è´¥:', error);
                alert('PDFç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

// é€šç”¨æ’åºå‡½æ•°ï¼šæº¢ä»·ç‡ä»å¤§åˆ°å°
function sortByPremium(history) {
    return history.sort((a, b) => parseFloat(b.premium) - parseFloat(a.premium));
}


        function getCurrencySymbol(country) {
            return { CHINA: 'Â¥', HK: 'HK$', US: '$', MY: 'RM' }[country];
        }

        // è¯­è¨€åˆ‡æ¢ï¼ˆå¹¶å¤„ç†éƒ¨åˆ† placeholder / æŒ‰é’®ï¼‰
        function changeLanguage(lang) {
            document.title = translations[lang].title;
            // æ›´æ–°æ‰€æœ‰ id ä»¥ key ç»“å°¾çš„æ–‡æœ¬ï¼ˆä¿æŒä½ åŸæ¥çš„é€»è¾‘ï¼‰
            Object.entries(translations[lang]).forEach(([key, value]) => {
                const elements = document.querySelectorAll(`[id$="${key}"]`);
                elements.forEach(el => el.textContent = value);
            });
            // ç‰¹æ®Šå¤„ç† placeholder / input / button
            document.getElementById('inputKey').placeholder = lang === 'zh' ? 'è¯·è¾“å…¥è®¿é—®å¯†é’¥' : 'Enter access key';
            document.getElementById('archiveName').placeholder = translations[lang].archiveInputPlaceholder;
            document.getElementById('createArchiveBtn').textContent = translations[lang].createArchiveButton;
            document.getElementById('deleteArchiveBtn').textContent = translations[lang].deleteArchiveButton;
            // å…¶å®ƒæŒ‰é’®ï¼ˆå¯¼å…¥/å¯¼å‡ºï¼‰ä¿æŒåŸæ–‡æˆ–å¯æ‰©å±•
            loadHistory();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initKey();
            lockCalculator();
            loadArchiveList();
            document.getElementById('languageSelect').addEventListener('change', () => {
                const lang = document.getElementById('languageSelect').value;
                changeLanguage(lang);
            });
            document.getElementById('calculateButton').addEventListener('click', calculate);
            // åˆå§‹è¯­è¨€ä¸ºä¸­æ–‡
            changeLanguage('zh');
        });
    </script>
</body>
</html>
