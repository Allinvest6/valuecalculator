<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta content="888888" name="app-key"/>
    <title>股票估值计算器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        .header { text-align: center; margin: 1rem 0 -3rem; }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 0.1rem; flex-wrap: wrap; margin-left: -150px; }
        .app-title { font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin: 0 0 0 -80px; line-height: 1.2; }
        .logo { height: 190px; width: auto; display: block; margin-bottom: -10px; }
        .calculator { max-width: 800px; margin: 2rem auto; padding: 2rem; border: 1px solid #dee2e6; border-radius: 15px; }
        .disabled-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 999; display: none; }
        .growth-input { position: relative; }
        .growth-input::after { content: "%"; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; pointer-events: none; }
        #recordCardsContainer { background-color: white; padding: 20px; }
        .card.shadow { box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important; }
        #stockContent > div { width: 300px; margin: 10px; padding: 15px; box-sizing: border-box; }
        @media (max-width: 768px) {
            .app-title { font-size: 2rem; }
            .logo { height: 150px; }
            .calculator { padding: 1.5rem; margin: 1rem; }
        }
/* 新增：导出报告里的股票卡片样式 */
.record-card {
    flex: 1 1 calc(33.333% - 20px);
    min-width: 260px;
    background: linear-gradient(135deg, #f9fafc, #eef2f7);
    border-radius: 20px;
    padding: 16px;
    margin: 10px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.record-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 20px rgba(0,0,0,0.15);
}
.record-card .stock-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 0.4rem;
}
.record-card .price {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0.2rem 0;
}
.record-card .current-price {
    color: #555;
}
.record-card .premium.positive {
    color: #27ae60;
}
.record-card .premium.negative {
    color: #e74c3c;
}
.record-card .timestamp {
    font-size: 0.8rem;
    color: #888;
    margin-top: 6px;
}

    </style>
</head>
<body>
    <div class="disabled-overlay" id="lockOverlay">
        <div class="position-absolute top-50 start-50 translate-middle">
            <div class="card shadow">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3" id="unlockTitle">需要解锁使用</h5>
                    <div class="input-group mb-3">
                        <input class="form-control" id="inputKey" placeholder="请输入访问密钥" type="password"/>
                        <button class="btn btn-outline-secondary" onclick="toggleKeyVisibility(this)">👁️</button>
                        <button class="btn btn-primary" onclick="unlockCalculator()">解锁</button>
                    </div>
                    <p class="text-danger small mb-0" id="keyError" style="display:none;"></p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="keyManagerModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="keyManagerTitle">密钥管理</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">当前密钥</label>
                        <input class="form-control" disabled id="currentKey" type="password"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密钥（至少6位）</label>
                        <input class="form-control" id="newKey" type="password"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">确认新密钥</label>
                        <input class="form-control" id="confirmKey" type="password"/>
                    </div>
                    <p class="text-danger small" id="keyChangeError" style="display:none;"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">取消</button>
                    <button class="btn btn-primary" onclick="updateKey()" type="button">保存更改</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <header class="header">
            <div class="logo-container">
                <img alt="Logo" class="logo" src="https://i.imgur.com/naIXUw2.png"/>
                <h1 class="app-title">股票估值计算器</h1>
            </div>
        </header>
        <div class="calculator">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label" id="languageLabel">Language</label>
                    <select class="form-select" id="languageSelect">
                        <option value="en">English</option>
                        <option value="zh">中文</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label" id="marketLabel">Market</label>
                    <select class="form-select" id="countrySelect">
                        <option value="CHINA">中国 (¥)</option>
                        <option value="HK">香港 (HK$)</option>
                        <option value="US">美国 ($)</option>
                        <option value="MY">马来西亚 (RM)</option>
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label" id="stockNameLabel">Stock Name</label>
                <input class="form-control" disabled id="stockName" required type="text"/>
                <label class="form-label mt-2" id="currentPriceLabel">当前股价</label>
                <input class="form-control" disabled id="currentPrice" min="0.01" required step="0.01" type="number"/>
            </div>
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label" id="quarterRevenueLabel">季度收入（百万）</label>
                    <input class="form-control" disabled id="quarterRevenue" min="0.01" required step="0.01" type="number"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label" id="quarterProfitLabel">季度利润（百万）</label>
                    <input class="form-control" disabled id="quarterProfit" min="0.01" required step="0.01" type="number"/>
                </div>
                <div class="col-md-3">
                    <label class="form-label" id="totalSharesLabel">总股本（百万股）</label>
                    <input class="form-control" disabled id="totalShares" min="1" required type="number"/>
                </div>
                <div class="col-md-3 growth-input">
                    <label class="form-label" id="growthLabel">预期成长值%</label>
                    <input class="form-control" disabled id="growthRate" max="100" min="0" required step="0.1" type="number" value="0"/>
                </div>
            </div>
            <button class="btn btn-primary w-100 mb-4" disabled id="calculateButton">Calculate & Save</button>
            <div class="mt-4 p-3 bg-light rounded" id="result" style="display: none;">
                <h5 id="resultTitle"></h5>
                <p class="fs-4 text-primary" id="resultPrice"></p>
                <p class="text-muted small mt-3" id="disclaimerText"></p>
            </div>
            <div class="history mt-5">
                <h5 class="mb-3" id="historyTitle">Saved Records</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th id="marketColumn">Market</th>
                                <th id="stockColumn">Stock</th>
                                <th id="currentPriceColumn">Current Price</th>
<th id="priceColumn">Price</th>
                                <th id="timeColumn">Time</th>
                                <th id="actionColumn">Action</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <button class="btn btn-success w-100 mb-4" onclick="generateAllRecordCards()">一键生成所有保存卡片 Generate all saved cards</button>
        <button class="btn btn-danger w-100 mb-4" onclick="downloadPDF()">下载PDF报告 Download PDF</button>
        <div class="mt-4" id="recordCardsContainer"></div>
    </div>
    <script>
        const translations = {
            zh: {
                title: "股票估值计算器",
                unlockTitle: "解锁使用",
                keyManagerTitle: "密钥管理",
                marketLabel: "选择市场",
                stockNameLabel: "股票名称",
                quarterRevenueLabel: "季度收入（百万）",
                quarterProfitLabel: "季度利润（百万）",
                totalSharesLabel: "总股本（百万股）",
                growthLabel: "预期成长值%",
                calculateButton: "计算并保存",
                resultTitle: "计算结果：",
                fairPrice: "合理股价：",
                disclaimer: "免责声明：计算结果仅供参考，不构成投资建议",
                growthNote: "（已包含{value}%的预期成长调整）",
                historyTitle: "保存记录",
                marketColumn: "市场",
                stockColumn: "股票名称",
                priceColumn: "合理股价",
                currentPriceColumn: "当前股价",
                timeColumn: "计算时间",
                actionColumn: "操作",
                deleteButton: "删除",
                errorInvalidInput: "请填写完整有效的输入值",
                errorNegativeProfit: "净利润率不能为负数",
                errorStockName: "股票名称不能为空",
                errorRevenue: "季度收入必须是有效数字",
                errorProfit: "季度利润必须是有效数字",
                errorShares: "总股本必须是大于零的数字",
                growthError: "成长值必须在0-100%之间",
                keyMismatch: "两次输入的密钥不一致",
                keyTooShort: "密钥长度不能少于6位",
                keyUpdated: "密钥已更新，请重新解锁！",
                errorNoRecords: "请先生成卡片再下载",
                currentPriceLabel: "当前股价",
                currentPrice: "当前股价",
                premiumRate: "溢价率",
                errorCurrentPrice: "当前股价必须为有效正数"

            },
            en: {
                title: "Stock Value Calculator",
                unlockTitle: "Unlock Required",
                keyManagerTitle: "Key Management",
                marketLabel: "Market",
                stockNameLabel: "Stock Name",
                quarterRevenueLabel: "Quarterly Rev (Mil)",
                quarterProfitLabel: "Quarterly Profit (Mil)",
                totalSharesLabel: "Total Shares (Mil)",
                growthLabel: "Growth Rate%",
                calculateButton: "Calculate & Save",
                resultTitle: "Result: ",
                fairPrice: "Fair Price: ",
                disclaimer: "Disclaimer: Results are for reference only and do not constitute investment advice. ",
                growthNote: "(Applied {value}% growth adjustment)",
                historyTitle: "History Records",
                marketColumn: "Market",
                stockColumn: "Stock",
                priceColumn: "Fair Price",
                currentPriceColumn: "Current Price",
                timeColumn: "Time",
                actionColumn: "Action",
                deleteButton: "Delete",
                errorInvalidInput: "Invalid input values",
                errorNegativeProfit: "Negative profit not allowed",
                errorStockName: "Stock name cannot be empty",
                errorRevenue: "Invalid revenue value",
                errorProfit: "Invalid profit value",
                errorShares: "Shares must be greater than zero",
                growthError: "Growth rate must be 0-100%",
                keyMismatch: "Keys do not match",
                keyTooShort: "Key must be at least 6 characters",
                keyUpdated: "Key updated! Please re-authenticate.",
                errorNoRecords: "Please generate cards first",
                currentPriceLabel: "Current Price",
                currentPrice: "Current Price",
                premiumRate: "Premium Rate",
                errorCurrentPrice: "Current price must be a valid positive number"
            }
        };

        let isLocked = true;

        function initKey() {
            const metaKey = document.querySelector('meta[name="app-key"]');
            if (metaKey && metaKey.content) {
                localStorage.setItem('appKey', metaKey.content);
                console.log('初始化密钥: 从meta标签设置', metaKey.content);
            } else {
                console.log('初始化密钥失败: meta标签未找到或无内容');
            }
            console.log('当前localStorage中的appKey:', localStorage.getItem('appKey'));
        }

        function toggleKeyVisibility(btn) {
            const input = btn.previousElementSibling;
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function unlockCalculator() {
            const inputKey = document.getElementById('inputKey').value;
            const savedKey = localStorage.getItem('appKey');
            const lang = document.getElementById('languageSelect').value;
            
            console.log('输入的密钥:', inputKey);
            console.log('保存的密钥:', savedKey);
            
            if (inputKey === savedKey) {
                console.log('密钥匹配，解锁计算器');
                isLocked = false;
                document.getElementById('lockOverlay').style.display = 'none';
                enableCalculator(true);
            } else {
                console.log('密钥不匹配，显示错误');
                showMessage('keyError', translations[lang].errorInvalidInput);
            }
        }

        function showKeyManager() {
            if (!isLocked) {
                const currentKey = localStorage.getItem('appKey');
                document.getElementById('currentKey').value = currentKey;
                new bootstrap.Modal('#keyManagerModal').show();
            }
        }

        function updateKey() {
            const newKey = document.getElementById('newKey').value;
            const confirmKey = document.getElementById('confirmKey').value;
            const lang = document.getElementById('languageSelect').value;

            if (newKey !== confirmKey) {
                showMessage('keyChangeError', translations[lang].keyMismatch);
                return;
            }
            if (newKey.length < 6) {
                showMessage('keyChangeError', translations[lang].keyTooShort);
                return;
            }

            localStorage.setItem('appKey', newKey);
            new bootstrap.Modal('#keyManagerModal').hide();
            alert(translations[lang].keyUpdated);
            lockCalculator();
        }

        function showMessage(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 2000);
        }

        function lockCalculator() {
            isLocked = true;
            document.getElementById('lockOverlay').style.display = 'block';
            enableCalculator(false);
        }

        function enableCalculator(enabled) {
            const elements = ['#stockName', '#currentPrice', '#quarterRevenue', '#quarterProfit', '#totalShares', 
                             '#calculateButton', '#languageSelect', '#countrySelect', '#growthRate'];
            elements.forEach(selector => {
                document.querySelector(selector).disabled = !enabled;
            });
            console.log('计算器状态:', enabled ? '已启用' : '已禁用');
        }

        function calculate() {
            const lang = document.getElementById('languageSelect').value;
            const country = document.getElementById('countrySelect').value;
            const stockName = document.getElementById('stockName').value.trim();
            const currentPrice = parseFloat(document.getElementById('currentPrice').value);
            const qRevenue = parseFloat(document.getElementById('quarterRevenue').value);
            const qProfit = parseFloat(document.getElementById('quarterProfit').value);
            const shares = parseFloat(document.getElementById('totalShares').value);
            const growthRate = parseFloat(document.getElementById('growthRate').value);

            if (!validateInputs(lang, stockName, currentPrice, qRevenue, qProfit, shares, growthRate)) return;

            const profitMargin = Math.round((qProfit / qRevenue) * 100);
            if (profitMargin < 0) {
                alert(translations[lang].errorNegativeProfit);
                return;
            }

            const adjustmentFactor = profitMargin * 0.2;
            const annualRevenue = qRevenue * 4;
            const baseValue = (annualRevenue * adjustmentFactor) / shares;
            let finalValue = baseValue * (1 + growthRate / 100);
            if (shares < 500) finalValue *= 0.8;
            else if (shares < 1000) finalValue *= 0.9;
            finalValue = Math.max(0, finalValue);
            const currency = { CHINA: '¥', HK: 'HK$', US: '$', MY: 'RM' }[country];

            showResult(lang, stockName, currency, finalValue, growthRate);
            saveRecord(country, stockName, finalValue, currentPrice, growthRate);
            loadHistory();
        }

        function validateInputs(lang, stockName, currentPrice, qRevenue, qProfit, shares, growthRate) {
            const errors = [];
            
            if (!stockName) errors.push(translations[lang].errorStockName);
            if (isNaN(currentPrice) || currentPrice <= 0) errors.push(translations[lang].errorCurrentPrice);
            if (isNaN(qRevenue) || qRevenue <= 0) errors.push(translations[lang].errorRevenue);
            if (isNaN(qProfit) || qProfit <= 0) errors.push(translations[lang].errorProfit);
            if (isNaN(shares) || shares <= 0) errors.push(translations[lang].errorShares);
            if (isNaN(growthRate) || growthRate < 0 || growthRate > 100) errors.push(translations[lang].growthError);

            if (errors.length > 0) {
                alert(`${translations[lang].errorInvalidInput}\n\n• ${errors.join('\n• ')}`);
                return false;
            }
            return true;
        }

        function showResult(lang, stockName, currency, value, growthRate) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            document.getElementById('resultTitle').textContent = `${translations[lang].resultTitle} ${stockName}`;
            document.getElementById('resultPrice').textContent = `${translations[lang].fairPrice} ${currency} ${value.toFixed(2)}`;
            document.getElementById('disclaimerText').textContent = translations[lang].disclaimer;
        }

        function saveRecord(country, name, price, currentPrice, growthRate) {
            const premium = ((price - currentPrice) / currentPrice * 100).toFixed(1);
            const record = {
                country: country,
                name: name,
                price: price.toFixed(2),
                currentPrice: currentPrice.toFixed(2),
                growth: growthRate.toFixed(1),
                premium: premium,
                timestamp: new Date().toLocaleString()
            };
            
            let history = JSON.parse(localStorage.getItem('stockHistory') || '[]');
            history = history.slice(-49);
            history.push(record);
            localStorage.setItem('stockHistory', JSON.stringify(history));
        }

        function loadHistory() {
            const lang = document.getElementById('languageSelect').value;
            const history = JSON.parse(localStorage.getItem('stockHistory') || '[]');
            const tbody = document.getElementById('historyTable');
            
            tbody.innerHTML = history.map((item, index) => `
                <tr>
                    <td>${item.country}</td>
                    <td>${item.name}</td>
                    <td>${getCurrencySymbol(item.country)} ${item.currentPrice}</td>
<td>${getCurrencySymbol(item.country)} ${item.price}<small class="${item.premium >= 0 ? 'text-success' : 'text-danger'}">(${item.premium}%)</small></td>
                    <td>${item.timestamp}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteRecord(${index})">${translations[lang].deleteButton}</button></td>
                </tr>
            `).join('');
        }

        function deleteRecord(index) {
            let history = JSON.parse(localStorage.getItem('stockHistory') || '[]');
            history.splice(index, 1);
            localStorage.setItem('stockHistory', JSON.stringify(history));
            loadHistory();
        }

        function getCurrencySymbol(country) {
            return { CHINA: '¥', HK: 'HK$', US: '$', MY: 'RM' }[country];
        }

        function generateAllRecordCards() {
            const history = JSON.parse(localStorage.getItem('stockHistory') || '[]');
            const container = document.getElementById('recordCardsContainer');
            container.innerHTML = '';

            if (history.length === 0) {
                const lang = document.getElementById('languageSelect').value;
                alert(translations[lang].errorNoRecords);
                return;
            }

            const lang = document.getElementById('languageSelect').value;
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'card shadow p-4';

            cardWrapper.innerHTML = `
                <div class="d-flex align-items-center mb-8" style="margin-left: 16rem;">
                    <img src="https://i.imgur.com/naIXUw2.png" alt="Logo" style="width: 400px; height: auto; margin-right: -7rem;">
                    <h2 style="font-size: 2.5rem;">${translations[lang].title}</h2>
                </div>
                <div class="text-center mb-4">
                    <p class="text-muted small mb-0" style="font-size: 0.9rem;">${translations[lang].disclaimer}</p>
                </div>
                <div class="d-flex flex-wrap" id="stockContent"></div>
            `;

            container.appendChild(cardWrapper);
            const stockContent = cardWrapper.querySelector('#stockContent');

            history.forEach((item) => {
    const stock = document.createElement('div');
    stock.className = 'record-card';
    stock.innerHTML = `
        <div class="stock-name">${item.name} (${item.country})</div>
        <div class="price">${translations[lang].priceColumn}: ${getCurrencySymbol(item.country)} ${item.price}</div>
        <div class="price current-price">${translations[lang].currentPrice}: ${getCurrencySymbol(item.country)} ${item.currentPrice}</div>
        <div class="premium ${item.premium >= 0 ? 'positive' : 'negative'}">${translations[lang].premiumRate}: ${item.premium}%</div>
        <div class="timestamp">${item.timestamp}</div>
    `;
    stockContent.appendChild(stock);
});

        }

        async function downloadPDF() {
            const container = document.getElementById('recordCardsContainer');
            const lang = document.getElementById('languageSelect').value;

            console.log('Starting PDF download...');
            console.log('Container children:', container.children.length);

            if (!container.children.length) {
                alert(translations[lang].errorNoRecords);
                return;
            }

            try {
                console.log('Running html2canvas...');
                const canvas = await new Promise(resolve => {
                    setTimeout(() => {
                        resolve(html2canvas(container, { 
                            scale: 2, 
                            useCORS: true, 
                            backgroundColor: '#ffffff' 
                        }));
                    }, 500);
                });
                console.log('Canvas generated:', canvas);

                const { jsPDF } = window.jspdf;
                console.log('jsPDF loaded:', jsPDF);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                console.log('Image data created:', imgData.length);

                const pageWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = pageWidth - 20;
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                console.log('Image added to PDF');
                pdf.save('stock_report.pdf');
                console.log('PDF saved');
            } catch (error) {
                console.error('PDF generation failed:', error);
                alert('PDF生成失败，请重试');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('html2canvas:', window.html2canvas);
            console.log('jspdf:', window.jspdf);
            initKey();
            lockCalculator();
            
            document.getElementById('languageSelect').addEventListener('change', () => {
                const lang = document.getElementById('languageSelect').value;
                changeLanguage(lang);
            });
            
            document.getElementById('calculateButton').addEventListener('click', calculate);
            changeLanguage('zh');
        });

        function changeLanguage(lang) {
            document.title = translations[lang].title;
            Object.entries(translations[lang]).forEach(([key, value]) => {
                const elements = document.querySelectorAll(`[id$="${key}"]`);
                elements.forEach(el => el.textContent = value);
            });
            document.getElementById('inputKey').placeholder = lang === 'zh' ? '请输入访问密钥' : 'Enter access key';
            loadHistory();
        }
    </script>
</body>
</html>
